@model Kinemathika.ViewModels.Teacher.StudentOverviewVm
@using System.Text.Json

@{
    ViewData["IsAuthPage"] = true;
    ViewData["Title"] = "Student Overview";
    Layout = "~/Views/Shared/_TeacherLayout.cshtml";

    Func<string, string> MapConceptName = id => id switch
    {
        "all" => "All Concepts",
        "C101" => "Speed and Velocity",
        "C102" => "Distance and Displacement",
        "C103" => "Acceleration",
        _ => id
    };
}

@section PageTitle {
    <div class="fw-bold mb-3">@Model.Name Overview</div>
}

<!-- KPI Row -->
<div class="row g-3 mb-3">
    <div class="col-12 col-md-4 col-lg-3">
        <div class="kpi-tile kpi-blue">
            <div class="kpi-label">Total Attempts</div>
            <div class="kpi-value">@Model.TotalAttempts</div>
        </div>
    </div>
    <div class="col-12 col-md-4 col-lg-3">
        <div class="kpi-tile kpi-orange">
            <div class="kpi-label">Avg Attempts</div>
            <div class="kpi-value">@Model.AvgAttemptsToCorrect.ToString("0.00")</div>
        </div>
    </div>
    <div class="col-12 col-md-4 col-lg-3">
        <div class="kpi-tile kpi-green">
            <div class="kpi-label">Avg Time to Correct</div>
            <div class="kpi-value">
                @{
                    var ts = TimeSpan.FromSeconds(Model.AvgTimeToCorrectSec);
                }
                @($"{(int)ts.TotalMinutes} min {ts.Seconds} sec")
            </div>
        </div>
    </div>
</div>

<!-- Progress + Concept Insights -->
<div class="card border-0 shadow-sm rounded-4 mb-3">
    <div class="card-body">
        <div class="row g-4">
            <!-- Donut -->
            <div class="col-12 col-xl-4 text-center d-flex flex-column align-items-center">
                <div class="position-relative" style="width:100%; max-width:260px; aspect-ratio:1;">
                    <canvas id="studentDonut"></canvas>
                    <div id="donutCenterText"
                        class="position-absolute top-50 start-50 translate-middle fw-bold text-success text-center"
                        style="font-size:1.4rem; line-height:1.4;">
                    </div>
                </div>
            </div>

            <!-- Concept KPIs + Trend -->
            <div class="col-12 col-xl-8">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="fw-semibold col-3">Select Concept</div>
                    <select id="conceptSelectInsights" class="form-select form-select-sm" style="min-width:280px;">
                        @foreach (var c in Model.Concepts)
                        {
                            <option value="@c.ConceptId">@MapConceptName(c.ConceptId)</option>
                        }
                    </select>
                </div>

                <!-- KPI Tiles -->
                <div class="row g-3 mb-4">
                    <div class="col-12 col-md-6">
                        <div class="kpi-tile kpi-orange text-center">
                            <div class="kpi-label small">Avg Attempts</div>
                            <div class="kpi-value fw-bold fs-4" id="conceptAvgAttempts">
                                @(Model.Concepts?.FirstOrDefault()?.AvgAttempts.ToString("0.00") ?? "0.00")
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="kpi-tile kpi-green text-center">
                            <div class="kpi-label small">Avg Time</div>
                            <div class="kpi-value fw-bold fs-4" id="conceptAvgTime">
                                @{
                                    var csecs = Model.Concepts?.FirstOrDefault()?.AvgTime ?? 0.0;
                                    var ct = TimeSpan.FromSeconds(csecs);
                                }
                                @($"{(int)ct.TotalMinutes} min {ct.Seconds} sec")
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trend Chart -->
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="fw-semibold">Trend Over Time</div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-primary" id="btnConceptAttempts">Attempts</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="btnConceptTime">Time</button>
                    </div>
                </div>
                <div>
                    <canvas id="conceptTrend" style="width:100%; height:350px;"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Attempts Table -->
<style>
    #recentAttemptsTable tbody tr {
        height: 48px;
    }

    #recentAttemptsTable thead {
        background-color: #f8f9fa;
        color: #495057;
    }

    #recentAttemptsTable {
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    #recentAttemptsTable tbody tr:hover {
        background-color: #f1f1f1;
    }

    .dataTables_paginate {
        font-size: 0.875rem;
    }

    .dataTables_filter input {
        border-radius: 0.375rem;
        border: 1px solid #ced4da;
        padding: 0.375rem;
    }
</style>
<div class="card border-0 shadow-sm rounded-4">
    <div class="card-body">
        <div class="fw-bold fs-5 mb-3">Recent Attempts</div>
        <table class="table table-hover table-striped mb-3 mt-3" id="recentAttemptsTable">
            <thead class="table-light">
                <tr>
                    <th>Ended</th>
                    <th>Concept</th>
                    <th>Problem</th>
                    <th>Status</th>
                    <th>First Try</th>
                    <th>Attempts</th>
                    <th>Time (s)</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.RecentAttempts != null && Model.RecentAttempts.Any())
                {
                    foreach (var r in Model.RecentAttempts)
                    {
                        <tr>
                            <td>@r.EndedAt.ToLocalTime()</td>
                            <td>@r.ConceptId</td>
                            <td>@r.ProblemId</td>
                            <td>@r.Status</td>
                            <td>@(r.FirstTry ? "Yes" : "No")</td>
                            <td>@r.Attempts</td>
                            <td>@r.TimeSec</td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="7" class="text-center">No attempts yet.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (function () {
            const concepts = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Concepts ?? []));
            if (!concepts.length) return; // exit if empty

            const donutCanvas = document.getElementById("studentDonut");
            const centerText = document.getElementById("donutCenterText");
            let donutChart = null;

            const initialConcept = concepts.find(c => c.ConceptId === "all") || concepts[0];

            function drawDonut(progressPct) {
                centerText.textContent = `Progress\n${Math.round(progressPct)}%`;

                if (donutChart) {
                    donutChart.data.datasets[0].data = [progressPct, 100 - progressPct];
                    donutChart.update();
                } else {
                    donutChart = new Chart(donutCanvas, {
                        type: 'doughnut',
                        data: {
                            datasets: [{
                                data: [progressPct, 100 - progressPct],
                                backgroundColor: ['#198754', '#e9ecef'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '72%',
                            plugins: {
                                legend: { display: false },
                                tooltip: { enabled: false }
                            }
                        }
                    });
                }
            }

            drawDonut((initialConcept.OverallProgress ?? 0) * 100);

            const conceptSel = document.getElementById("conceptSelectInsights");
            conceptSel.addEventListener("change", function () {
                const selected = concepts.find(c => c.ConceptId === this.value) || concepts[0];
                drawDonut((selected.OverallProgress ?? 0) * 100);
                updateConceptSummary(selected);
                const metric = btnA.classList.contains("btn-primary") ? "Attempts" : "Time";
                drawTrend(metric, selected);
            });

            // --- Trend Chart ---
            const valAttempts = document.getElementById("conceptAvgAttempts");
            const valTime = document.getElementById("conceptAvgTime");
            const btnA = document.getElementById("btnConceptAttempts");
            const btnT = document.getElementById("btnConceptTime");
            const trendCanvas = document.getElementById("conceptTrend");
            let selectedConcept = initialConcept;
            let trendChart = null;

            function updateConceptSummary(concept) {
                valAttempts.textContent = (concept.AvgAttempts ?? 0).toFixed(2);
                const secs = Math.round(concept.AvgTime ?? 0);
                valTime.textContent = `${Math.floor(secs / 60)} min ${secs % 60} sec`;
            }

            function drawTrend(metric, concept) {
                const trendData = metric === "Attempts" ? concept.AttemptsTrend : concept.TimeTrend;
                const ctx = trendCanvas.getContext('2d');
                ctx.clearRect(0, 0, trendCanvas.width, trendCanvas.height);

                if (!trendData?.length) return;

                const labels = trendData.map(pt => pt.Date);
                const data = trendData.map(pt => pt.Value);

                if (trendChart) trendChart.destroy();
                trendChart = new Chart(trendCanvas, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: metric === "Attempts" ? "Avg Attempts" : "Avg Time (sec)",
                            data,
                            borderColor: metric === "Attempts" ? "#fd7e14" : "#198754",
                            backgroundColor: "rgba(0,0,0,0)",
                            tension: 0.3,
                            pointRadius: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { title: { display: true, text: "Date" }, ticks: { autoSkip: true, maxTicksLimit: 6 } },
                            y: { title: { display: true, text: metric === "Attempts" ? "Attempts" : "Seconds" } }
                        }
                    }
                });
            }

            updateConceptSummary(selectedConcept);
            drawTrend("Attempts", selectedConcept);

            btnA.addEventListener("click", function () {
                btnA.classList.add("btn-primary"); btnA.classList.remove("btn-outline-primary");
                btnT.classList.remove("btn-primary"); btnT.classList.add("btn-outline-primary");
                drawTrend("Attempts", selectedConcept);
            });
            btnT.addEventListener("click", function () {
                btnT.classList.add("btn-primary"); btnT.classList.remove("btn-outline-primary");
                btnA.classList.remove("btn-primary"); btnA.classList.add("btn-outline-primary");
                drawTrend("Time", selectedConcept);
            });

            // DataTables
            $(document).ready(function () {
                $('#recentAttemptsTable').DataTable({
                    pageLength: 10,
                    lengthMenu: [5, 10, 25],
                    responsive: true
                });
            });
        })();
    </script>
}
