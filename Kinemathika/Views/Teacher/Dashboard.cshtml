@* Views/Teacher/Dashboard.cshtml
   WHAT IT DOES: Adds an Overview section (KPIs + per‑concept bars + recent attempts)
   above the existing Students/Reports tabs. *@
@model Kinemathika.ViewModels.Teacher.TeacherDashboardVm
@using Kinemathika.ViewModels.Teacher
@{
    ViewData["IsAuthPage"] = true;
    ViewData["Title"] = "Teacher Dashboard";
    var sidebar = ViewBag.Sidebar as SidebarVm ?? new SidebarVm();

    var pageTitle = Model.IsOverall
        ? "Overall Overview"
        : $"Class Overview — {Model.CurrentClassName}";
}
    <div class="container-xxl py-3">
        <!-- Top bar -->
        <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="fw-semibold">Dashboard</div>
            <a class="btn btn-outline-danger" asp-controller="Account" asp-action="Login">Logout</a>
        </div>

        <div class="row g-4">
            <!-- Sidebar -->
            <div class="col-12 col-lg-3">
                <partial name="~/Views/Shared/_TeacherSidebar.cshtml" model="sidebar" />
            </div>

            <!-- Main -->
            <div class="col-12 col-lg-9">
                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-body">
                        <div class="fw-semibold mb-3">@pageTitle</div>

                    @* ========== OVERVIEW (NEW) ========== *@
                    @if (Model.Overview is not null)
                    {
                        <div class="mb-4">
                            <div class="fw-semibold mb-2">Overview</div>

                            <!-- KPI row 1 -->
                            <div class="row g-3 mb-2">
                                <div class="col-12 col-md-4">
                                    <div class="border rounded-3 p-3 h-100">
                                        <div class="small text-muted">Classes</div>
                                        <div class="fs-4 fw-bold">@Model.Overview.TotalClasses</div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-4">
                                    <div class="border rounded-3 p-3 h-100">
                                        <div class="small text-muted">Students</div>
                                        <div class="fs-4 fw-bold">@Model.Overview.TotalStudents</div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-4">
                                    <div class="border rounded-3 p-3 h-100">
                                        <div class="small text-muted">Avg Accuracy</div>
                                        <div class="fs-4 fw-bold">@string.Format("{0:P0}", Model.Overview.AvgAccuracy)</div>
                                    </div>
                                </div>
                            </div>

                            <!-- KPI row 2 -->
                            <div class="row g-3 mb-3">
                                <div class="col-12 col-md-4">
                                    <div class="border rounded-3 p-3 h-100">
                                        <div class="small text-muted">First‑Try Correct</div>
                                        <div class="fs-5 fw-semibold">@string.Format("{0:P0}", Model.Overview.FirstTryCorrectRate)</div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-4">
                                    <div class="border rounded-3 p-3 h-100">
                                        <div class="small text-muted">Mastery Rate</div>
                                        <div class="fs-5 fw-semibold">@string.Format("{0:P0}", Model.Overview.MasteryRate)</div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-4">
                                    <div class="border rounded-3 p-3 h-100">
                                        <div class="small text-muted">Avg Time to Correct</div>
                                        <div class="fs-5 fw-semibold">@Model.Overview.AvgTimeToCorrectSec s</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Per‑concept accuracy bars -->
                            <div class="border rounded-3 p-3 mb-3">
                                <div class="fw-semibold mb-2">Concept Accuracy</div>
                                <div class="d-flex align-items-end gap-3" style="min-height: 220px;">
                                    @for (int i = 0; i < Model.Overview.Concepts.Count; i++)
                                    {
                                        var pct = Model.Overview.ConceptAvgAccuracyPct[i];
                                        <div class="text-center">
                                            <div style="width:48px; height:@pct%; background:#198754; border-radius:.5rem .5rem 0 0;"></div>
                                            <div class="small mt-1 text-muted" style="width:60px;">@Model.Overview.Concepts[i]</div>
                                        </div>
                                    }
                                </div>
                            </div>

                            @* WHAT IT DOES: Show Recent Attempts ONLY on Overall Overview *@
                            @if (Model.IsOverall)
                            {
                                <div class="border rounded-3 p-3">
                                    <div class="fw-semibold mb-2">Recent Attempts (All Classes)</div>

                                    @if (Model.Overview?.RecentAttempts?.Any() == true)
                                    {
                                        <div class="table-responsive rounded-3">
                                            <table class="table align-middle mb-0">
                                                <thead class="table-success">
                                                    <tr>
                                                        <th>Ended</th>
                                                        <th>Student</th>
                                                        <th>Concept</th>
                                                        <th>Problem</th>
                                                        <th>Status</th>
                                                        <th>First Try</th>
                                                        <th>Attempts</th>
                                                        <th>Time (s)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var r in Model.Overview.RecentAttempts)
                                                    {
                                                        <tr>
                                                            <td>@r.EndedAt.ToLocalTime()</td>
                                                            <td>@r.StudentId</td>
                                                            <td>@r.ConceptId</td>
                                                            <td>@r.ProblemId</td>
                                                            <td>@r.Status</td>
                                                            <td>@(r.FirstTry ? "Yes" : "No")</td>
                                                            <td>@r.Attempts</td>
                                                            <td>@r.TimeSec</td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="alert alert-light border mb-0">No recent attempts.</div>
                                    }
                                </div>
                            }

                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning mb-4">
                            No overview data yet. Once attempts are recorded in the database, this section will populate.
                        </div>
                    }
                    @* ========== /OVERVIEW (NEW) ========== *@

                    @* ======= EXISTING TABS (unchanged) ======= *@
                    <ul class="nav nav-tabs mb-3">
                        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-students">Students</a></li>
                        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-reports">Reports</a></li>
                    </ul>

                    <div class="tab-content">
                        <!-- Students tab -->
                        @* WHAT IT DOES: In Overall Overview, show class tabs with a table per class.*@
                        <div class="tab-pane fade show active" id="tab-students">
                            @if (Model.IsOverall)
                            {
                                @* Tabs: one per active class *@
                                <ul class="nav nav-pills mb-3" id="students-class-tabs" role="tablist">
                                    @{
                                        var idx = 0;
                                    }
                                    @foreach (var t in Model.StudentTabs)
                                    {
                                        var active = idx == 0 ? "active" : "";
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link @active"
                                                    id="tab-@t.ClassId"
                                                    data-bs-toggle="tab"
                                                    data-bs-target="#pane-@t.ClassId"
                                                    type="button" role="tab"
                                                    aria-controls="pane-@t.ClassId"
                                                    aria-selected="@(idx == 0 ? "true" : "false")">
                                                @t.ClassName
                                            </button>
                                        </li>
                                        idx++;
                                    }
                                </ul>

                                <div class="tab-content">
                                    @{
                                        var paneIdx = 0;
                                    }
                                    @foreach (var t in Model.StudentTabs)
                                    {
                                        var show = paneIdx == 0 ? "show active" : "";
                                        <div class="tab-pane fade @show" id="pane-@t.ClassId" role="tabpanel" aria-labelledby="tab-@t.ClassId">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <div class="fw-semibold">Students in @t.ClassName</div>
                                                <div class="input-group" style="max-width: 280px;">
                                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                                    <input class="form-control" placeholder="Search students">
                                                </div>
                                            </div>

                                            @if (t.Students?.Any() == true)
                                            {
                                                <div class="table-responsive">
                                                    <table class="table table-sm align-middle">
                                                        <thead>
                                                            <tr class="table-success">
                                                                <th>Name</th>
                                                                <th class="d-none d-md-table-cell">Email</th>
                                                                <th class="text-center">Attempts</th>
                                                                <th class="text-center">Avg Accuracy</th>
                                                                <th class="d-none d-md-table-cell">Last Active</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @foreach (var s in t.Students)
                                                            {
                                                                <tr>
                                                                    @* WHAT IT DOES: Clicking a student opens their overview *@
                                                                    <td>
                                                                        <a asp-action="Student" asp-route-studentId="@s.StudentId" class="text-decoration-none">
                                                                            @s.Name
                                                                        </a>
                                                                    </td>

                                                                    <td class="d-none d-md-table-cell">@s.Email</td>
                                                                    <td class="text-center">@s.TotalAttempts</td>
                                                                    <td class="text-center">@string.Format("{0:P0}", s.AvgAccuracy)</td>
                                                                    <td class="d-none d-md-table-cell">@((s.LastActive?.ToString("dd/MM/yyyy h:mm tt")) ?? "-")</td>
                                                                </tr>
                                                            }
                                                        </tbody>
                                                    </table>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="alert alert-light border mb-0">No students in this class.</div>
                                            }
                                        </div>
                                        paneIdx++;
                                    }
                                </div>
                            }
                            else
                            {
                                @* Class Overview (unchanged single table using Model.Students) *@
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="fw-semibold">Students in @Model.CurrentClassName</div>
                                    <div class="input-group" style="max-width: 280px;">
                                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                                        <input class="form-control" placeholder="Search students">
                                    </div>
                                </div>

                                <div class="table-responsive">
                                    <table class="table table-sm align-middle">
                                        <thead>
                                            <tr class="table-success">
                                                <th>Name</th>
                                                <th class="d-none d-md-table-cell">Email</th>
                                                <th class="text-center">Attempts</th>
                                                <th class="text-center">Avg Accuracy</th>
                                                <th class="d-none d-md-table-cell">Last Active</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var s in Model.Students)
                                            {
                                                <tr>
                                                    <td>
                                                        <a asp-action="Student" asp-route-studentId="@s.StudentId" class="text-decoration-none">
                                                            @s.Name
                                                        </a>
                                                    </td>

                                                    <td class="d-none d-md-table-cell">@s.Email</td>
                                                    <td class="text-center">@s.TotalAttempts</td>
                                                    <td class="text-center">@string.Format("{0:P0}", s.AvgAccuracy)</td>
                                                    <td class="d-none d-md-table-cell">@((s.LastActive?.ToString("dd/MM/yyyy h:mm tt")) ?? "-")</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                        </div>

                        <!-- Reports tab -->
                        <div class="tab-pane fade" id="tab-reports">
                            <div class="fw-semibold mb-2">Overall Statistics</div>
                            <div class="d-flex align-items-end gap-3" style="height:220px;">
                                @for (int i = 0; i < Model.Report.Bars.Count; i++)
                                {
                                    var h = Model.Report.Bars[i];
                                    <div class="text-center">
                                        <div style="width:48px; height:@h% ; background:#198754; border-radius:.5rem .5rem 0 0;"></div>
                                        <div class="small mt-1 text-muted" style="width:60px;">@Model.Report.Labels[i]</div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div> <!-- /tab-content -->
                </div>
            </div>
        </div>
    </div>
</div>
